<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Controle de Estoque v7</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.5); }
        .modal { transition: opacity 0.3s ease, transform 0.3s ease; }
        .modal-content { max-height: 90vh; }
        .nav-btn-active { background-color: #2563eb; color: white; }
        .nav-btn { background-color: white; color: #374151; }
        .report-nav-btn, .report-nav-btn-active { padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 500; transition: background-color 0.2s, color 0.2s; }
        .report-nav-btn-active { background-color: #2563eb; color: white; }
        .report-nav-btn { background-color: #f3f4f6; color: #374151; }
        .report-nav-btn:hover { background-color: #e5e7eb; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Tela de Login -->
    <div id="login-screen" class="flex items-center justify-center h-screen">
        <div class="w-full max-w-md p-8 space-y-8 bg-white rounded-lg shadow-md">
            <div class="text-center">
                <i class="fas fa-boxes-stacked text-5xl text-blue-600"></i>
                <h2 class="mt-6 text-3xl font-bold text-gray-900">EstoquePRO</h2>
                <p class="mt-2 text-sm text-gray-600">Acesse sua conta para continuar</p>
            </div>
            <form id="login-form" class="mt-8 space-y-6">
                <div class="rounded-md shadow-sm -space-y-px">
                    <div><input id="login-email" name="email" type="email" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" placeholder="Email"></div>
                    <div><input id="login-password" name="password" type="password" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" placeholder="Senha"></div>
                </div>
                <div><button type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Entrar</button></div>
            </form>
            <p id="login-error" class="text-center text-sm text-red-600"></p>
        </div>
    </div>

    <!-- Conteúdo Principal da Aplicação (escondido inicialmente) -->
    <div id="main-app" class="hidden">
        <!-- Barra de Navegação Superior -->
        <nav class="bg-white shadow-md">
            <div class="container mx-auto px-4">
                <div class="flex justify-between items-center py-3">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-boxes-stacked text-2xl text-blue-600"></i>
                        <span class="text-xl font-bold">EstoquePRO</span>
                    </div>
                    <div id="main-nav" class="hidden md:flex items-center space-x-1">
                        <button data-view="estoque" class="nav-btn-active px-3 py-2 rounded-md text-sm font-medium">Estoque</button>
                        <button data-view="relatorios" class="nav-btn px-3 py-2 rounded-md text-sm font-medium">Relatórios</button>
                        <div class="relative">
                            <button id="cadastros-menu-btn" class="nav-btn px-3 py-2 rounded-md text-sm font-medium flex items-center">
                                Cadastros <i class="fas fa-chevron-down ml-2 text-xs"></i>
                            </button>
                            <div id="cadastros-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-20">
                                <a href="#" data-view="localidades" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Localidades</a>
                                <a href="#" data-view="fornecedores" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Fornecedores</a>
                                <a href="#" data-view="categorias" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Categorias</a>
                                <a href="#" data-view="fabricantes" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Fabricantes</a>
                                <a href="#" data-view="usuarios" id="nav-usuarios" class="hidden block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Usuários</a>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center ml-4">
                         <span id="username-display" class="text-sm text-gray-500 mr-4 font-semibold"></span>
                         <button id="logout-btn" class="text-sm text-red-500 hover:text-red-700 font-medium flex items-center"><i class="fas fa-sign-out-alt mr-1"></i>Sair</button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Container Principal -->
        <div class="container mx-auto p-4 md:p-8">
            <header id="viewHeader" class="flex flex-col md:flex-row justify-between items-center mb-6"></header>
            <main id="viewContainer"></main>
            <div id="loading" class="text-center py-10"><i class="fas fa-spinner fa-spin fa-3x text-blue-500"></i><p class="mt-2 text-gray-600">Carregando dados...</p></div>
            <div id="semDados" class="hidden text-center py-10 bg-white rounded-lg shadow"><i class="fas fa-box-open fa-3x text-gray-400"></i><p class="mt-4 text-xl text-gray-500">Nenhum item encontrado.</p><p class="text-gray-400">Comece adicionando itens no botão correspondente.</p></div>
        </div>
    </div>

    <!-- Modais -->
    <div id="modalProduto" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">...</div>
    <div id="modalAuxiliar" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">...</div>
    <div id="modalDetalhes" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">...</div>
    <div id="modalMovimentar" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">...</div>
    <div id="modalUsuario" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">...</div>
    
    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, getDocs, addDoc, setDoc, updateDoc, deleteDoc, collection, query, where, serverTimestamp, runTransaction, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURAÇÃO E ESTADO GLOBAL ---
        const firebaseConfig = {
          apiKey: "AIzaSyA2QbTc66Hir01rxRBO8d8jbldBbdYVNHQ",
          authDomain: "estoque-5bd20.firebaseapp.com",
          projectId: "estoque-5bd20",
          storageBucket: "estoque-5bd20.appspot.com",
          messagingSenderId: "877422312225",
          appId: "1:877422312225:web:b600eaae6f06a752575c60"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUser = null;
        let currentUserRole = null;
        let currentView = 'estoque';
        
        const caches = {
            produtos: new Map(), localidades: new Map(), categorias: new Map(),
            fabricantes: new Map(), fornecedores: new Map(), usuarios: new Map(),
            estoque: [], historico: []
        };
        const collections = ['produtos', 'localidades', 'categorias', 'fabricantes', 'fornecedores', 'usuarios', 'estoque', 'historico'];

        // --- ELEMENTOS DO DOM ---
        const loginScreen = document.getElementById('login-screen');
        const mainAppScreen = document.getElementById('main-app');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const logoutBtn = document.getElementById('logout-btn');
        const usernameDisplay = document.getElementById('username-display');
        
        const loadingEl = document.getElementById('loading');
        const semDadosEl = document.getElementById('semDados');
        const viewContainer = document.getElementById('viewContainer');
        const viewHeader = document.getElementById('viewHeader');
        const mainNav = document.getElementById('main-nav');
        
        // --- INICIALIZAÇÃO E AUTENTICAÇÃO ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const userDocRef = doc(db, "usuarios", user.uid);
                try {
                    const userDoc = await getDoc(userDocRef);
                    if (userDoc.exists()) {
                        currentUserRole = userDoc.data().role;
                        usernameDisplay.textContent = userDoc.data().username || user.email;
                        loginScreen.classList.add('hidden');
                        mainAppScreen.classList.remove('hidden');
                        await iniciarSistema();
                    } else {
                        loginError.textContent = "Perfil de usuário não encontrado no banco de dados. Contate o administrador.";
                        await signOut(auth);
                    }
                } catch (error) {
                    console.error("Erro detalhado ao buscar perfil do usuário:", error);
                    loginError.textContent = "Erro ao carregar dados do usuário. Verifique as permissões do Firestore.";
                    await signOut(auth);
                }
            } else {
                currentUser = null;
                currentUserRole = null;
                loginScreen.classList.remove('hidden');
                mainAppScreen.classList.add('hidden');
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loginError.textContent = '';
            const email = loginForm.email.value;
            const password = loginForm.password.value;
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Login error:", error.code);
                loginError.textContent = "Email ou senha inválidos.";
            }
        });

        logoutBtn.addEventListener('click', async () => {
            await signOut(auth);
        });

        async function iniciarSistema() {
            loadingEl.style.display = 'block';
            for (const name of collections) {
                const q = query(collection(db, name));
                const snapshot = await getDocs(q);
                if (['estoque', 'historico'].includes(name)) {
                    caches[name] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                } else {
                    caches[name].clear();
                    snapshot.forEach(doc => caches[name].set(doc.id, { id: doc.id, ...doc.data() }));
                }
            }
            
            document.getElementById('nav-usuarios').style.display = currentUserRole === 'master' ? 'block' : 'none';

            loadingEl.style.display = 'none';
            renderizarView();
        }

        // --- LÓGICA DE NAVEGAÇÃO E RENDERIZAÇÃO ---
        const cadastrosBtn = document.getElementById('cadastros-menu-btn');
        const cadastrosDropdown = document.getElementById('cadastros-dropdown');

        cadastrosBtn.addEventListener('click', () => {
            cadastrosDropdown.classList.toggle('hidden');
        });

        document.addEventListener('click', (e) => {
            if (!cadastrosBtn.contains(e.target) && !cadastrosDropdown.contains(e.target)) {
                cadastrosDropdown.classList.add('hidden');
            }
        });

        mainNav.addEventListener('click', (e) => {
            const target = e.target.closest('button, a');
            if (target && target.dataset.view) {
                e.preventDefault();
                currentView = target.dataset.view;
                
                mainNav.querySelectorAll('button, a').forEach(el => {
                    el.classList.remove('nav-btn-active');
                    if(el.tagName === 'BUTTON' && !el.parentElement.classList.contains('relative')) el.classList.add('nav-btn');
                });
                
                if (target.closest('#cadastros-dropdown')) {
                    cadastrosBtn.classList.add('nav-btn-active');
                    cadastrosBtn.classList.remove('nav-btn');
                } else {
                    target.classList.add('nav-btn-active');
                    target.classList.remove('nav-btn');
                    cadastrosBtn.classList.remove('nav-btn-active');
                    cadastrosBtn.classList.add('nav-btn');
                }
                
                cadastrosDropdown.classList.add('hidden');
                renderizarView();
            }
        });

        function renderizarView() {
            viewContainer.innerHTML = '';
            semDadosEl.style.display = 'none';
            const renderMap = {
                estoque: renderizarViewEstoque,
                relatorios: renderizarViewRelatorios,
                localidades: () => renderizarViewAuxiliar('localidades', 'Localidades'),
                fornecedores: () => renderizarViewAuxiliar('fornecedores', 'Fornecedores'),
                categorias: () => renderizarViewAuxiliar('categorias', 'Categorias'),
                fabricantes: () => renderizarViewAuxiliar('fabricantes', 'Fabricantes'),
                usuarios: renderizarViewUsuarios,
            };
            if(renderMap[currentView]) {
                renderMap[currentView]();
            }
        }
        
        function renderizarHeader(title, buttonInfo = null) {
            let buttonHtml = '';
            if (buttonInfo && (currentUserRole === 'master' || buttonInfo.id !== 'abrirModalUsuario')) {
                buttonHtml = `<button id="${buttonInfo.id}" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 flex items-center"><i class="${buttonInfo.icon} mr-2"></i>${buttonInfo.text}</button>`;
            }
            viewHeader.innerHTML = `
                <div><h1 class="text-2xl font-bold text-gray-800">${title}</h1></div>
                <div class="flex items-center space-x-4 mt-4 md:mt-0">
                    <input type="text" id="filtroBusca" placeholder="Buscar..." class="w-full md:w-auto p-2 border border-gray-300 rounded-lg">
                    ${buttonHtml}
                </div>
            `;
            document.getElementById('filtroBusca').addEventListener('input', aplicarFiltros);
        }

        // --- VIEWS PRINCIPAIS ---
        function renderizarViewEstoque() {
            renderizarHeader('Visão Geral do Estoque', {id: 'abrirModalAdicionar', text: 'Adicionar Produto', icon: 'fas fa-plus'});
            document.getElementById('abrirModalAdicionar').addEventListener('click', () => abrirModalProduto());

            if (caches.produtos.size === 0) { semDadosEl.style.display = 'block'; return; }
            const grid = document.createElement('div');
            grid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
            
            caches.produtos.forEach(produto => {
                const totalEstoque = caches.estoque.filter(e => e.produtoId === produto.id).reduce((sum, e) => sum + e.quantidade, 0);
                const card = document.createElement('div');
                card.className = "card-item bg-white rounded-lg shadow-md overflow-hidden";
                card.dataset.filterKey = `${produto.nome} ${caches.fabricantes.get(produto.fabricanteId)?.nome || ''} ${produto.modelo} ${produto.serialNumber || ''}`.toLowerCase();
                const cor = totalEstoque <= 0 ? 'text-red-500' : 'text-green-600';
                card.innerHTML = `
                    <div class="flex items-start p-4">
                        <img src="${produto.foto_url || 'https://placehold.co/100x100/e2e8f0/cbd5e0?text=N/A'}" alt="Foto" class="w-24 h-24 object-cover rounded-md mr-4">
                        <div class="flex-grow">
                            <h3 class="font-bold text-lg">${produto.nome}</h3>
                            <p class="text-sm text-gray-500">${caches.fabricantes.get(produto.fabricanteId)?.nome || ''} ${produto.modelo || ''}</p>
                            <p class="text-xs text-gray-400 font-mono">${produto.serialNumber || ''}</p>
                            <div class="mt-2 text-xl font-bold ${cor}">${totalEstoque} <span class="text-sm font-medium text-gray-500">${produto.unidade}</span></div>
                            <p class="text-xs text-gray-400">em ${caches.estoque.filter(e => e.produtoId === produto.id && e.quantidade > 0).length} locais</p>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-3 flex justify-end space-x-3">
                        <button data-action="detalhes" data-id="${produto.id}" class="text-sm text-blue-600 font-semibold">Detalhes</button>
                        <button data-action="movimentar" data-id="${produto.id}" class="text-sm text-green-600 font-semibold">Movimentar</button>
                        <button data-action="editar-produto" data-id="${produto.id}" class="text-sm text-yellow-600 font-semibold">Editar</button>
                    </div>`;
                grid.appendChild(card);
            });
            viewContainer.appendChild(grid);
            viewContainer.addEventListener('click', handleCardClick);
        }

        // ... O restante do código JavaScript permanece o mesmo da versão anterior
        // ... (renderizarViewAuxiliar, aplicarFiltros, handleCardClick, excluirItem, excluirProduto, modais, etc.)
        
        // --- LÓGICA DE RELATÓRIOS ---
        function renderizarViewRelatorios() {
            renderizarHeader('Relatórios');
            let reportNavButtons = `
                <button data-report="estoquePorLocal" class="report-nav-btn-active">Estoque por Local</button>
                <button data-report="movimentacoes" class="report-nav-btn">Movimentações</button>
                <button data-report="listaEstoque" class="report-nav-btn">Lista de Estoque</button>
                <button data-report="listaFabricante" class="report-nav-btn">Lista por Fabricante</button>
            `;
            if (currentUserRole === 'master') {
                reportNavButtons += `<button data-report="movimentacoesUsuario" class="report-nav-btn">Movimentações por Usuário</button>`;
            }

            viewContainer.innerHTML = `
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <div id="report-nav" class="flex flex-wrap gap-2 border-b border-gray-200 mb-4 pb-2">
                        ${reportNavButtons}
                    </div>
                    <div id="report-content"></div>
                </div>
            `;
            
            const reportNav = document.getElementById('report-nav');
            reportNav.addEventListener('click', e => {
                if (e.target.tagName === 'BUTTON') {
                    reportNav.querySelectorAll('button').forEach(btn => {
                        btn.classList.remove('report-nav-btn-active');
                        btn.classList.add('report-nav-btn');
                    });
                    e.target.classList.add('report-nav-btn-active');
                    e.target.classList.remove('report-nav-btn');
                    renderizarRelatorio(e.target.dataset.report);
                }
            });
            renderizarRelatorio('estoquePorLocal'); // Renderiza o primeiro relatório por padrão
        }

        function renderizarRelatorio(reportName) {
            const content = document.getElementById('report-content');
            content.innerHTML = '';
            switch (reportName) {
                case 'estoquePorLocal': renderRelatorioEstoquePorLocal(content); break;
                case 'movimentacoes': renderRelatorioMovimentacoes(content); break;
                case 'listaEstoque': renderRelatorioListaEstoque(content); break;
                case 'listaFabricante': renderRelatorioListaFabricante(content); break;
                case 'movimentacoesUsuario': renderRelatorioMovimentacoesUsuario(content); break;
            }
        }

        // ... (resto do código dos relatórios e outras funções)
        function renderizarViewUsuarios() {
            renderizarHeader('Gestão de Usuários', {id: 'abrirModalUsuario', text: 'Adicionar Usuário', icon: 'fas fa-plus'});
            document.getElementById('abrirModalUsuario').addEventListener('click', () => abrirModalUsuario());

            const list = document.createElement('div');
            list.className = 'bg-white rounded-lg shadow-md divide-y divide-gray-200';
            
            caches.usuarios.forEach((user, id) => {
                list.innerHTML += `
                    <div class="card-item p-4 flex justify-between items-center" data-filter-key="${user.username.toLowerCase()} ${user.email.toLowerCase()}">
                        <div>
                            <span class="font-medium">${user.username}</span>
                            <span class="text-sm text-gray-500 ml-4">${user.email}</span>
                            <span class="ml-4 text-xs font-semibold uppercase px-2 py-1 rounded-full ${user.role === 'master' ? 'bg-blue-200 text-blue-800' : 'bg-gray-200 text-gray-800'}">${user.role}</span>
                        </div>
                        ${currentUser.uid !== id ? // Não pode excluir a si mesmo
                        `<div>
                            <button data-action="excluir-usuario" data-id="${id}" class="text-red-600 px-2"><i class="fas fa-trash"></i></button>
                        </div>` : ''}
                    </div>`;
            });
            viewContainer.appendChild(list);
            viewContainer.addEventListener('click', handleCardClick);
        }

    </script>
</body>
</html>
