<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Controle de Estoque v7</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.5); }
        .modal { transition: opacity 0.3s ease, transform 0.3s ease; }
        .modal-content { max-height: 90vh; }
        .nav-btn-active { background-color: #2563eb; color: white; }
        .nav-btn { background-color: white; color: #374151; }
        .report-nav-btn, .report-nav-btn-active { padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 500; transition: background-color 0.2s, color 0.2s; }
        .report-nav-btn-active { background-color: #2563eb; color: white; }
        .report-nav-btn { background-color: #f3f4f6; color: #374151; }
        .report-nav-btn:hover { background-color: #e5e7eb; }
        .filter-active { background-color: #e0e7ff; border-color: #4f46e5; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Tela de Login -->
    <div id="login-screen" class="flex items-center justify-center h-screen">
        <div class="w-full max-w-md p-8 space-y-8 bg-white rounded-lg shadow-md">
            <div class="text-center">
                <i class="fas fa-boxes-stacked text-5xl text-blue-600"></i>
                <h2 class="mt-6 text-3xl font-bold text-gray-900">EstoquePRO</h2>
                <p class="mt-2 text-sm text-gray-600">Acesse sua conta para continuar</p>
            </div>
            <form id="login-form" class="mt-8 space-y-6">
                <div class="rounded-md shadow-sm -space-y-px">
                    <div><input id="login-email" name="email" type="email" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" placeholder="Email"></div>
                    <div><input id="login-password" name="password" type="password" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" placeholder="Senha"></div>
                </div>
                <div><button type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Entrar</button></div>
            </form>
            <p id="login-error" class="text-center text-sm text-red-600"></p>
        </div>
    </div>

    <!-- Conteúdo Principal da Aplicação (escondido inicialmente) -->
    <div id="main-app" class="hidden">
        <!-- Barra de Navegação Superior -->
        <nav class="bg-white shadow-md">
            <div class="container mx-auto px-4">
                <div class="flex justify-between items-center py-3">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-boxes-stacked text-2xl text-blue-600"></i>
                        <span class="text-xl font-bold">EstoquePRO</span>
                    </div>
                    <div id="main-nav" class="hidden md:flex items-center space-x-1">
                        <button data-action="navigate-view" data-view="estoque" class="nav-btn-active px-3 py-2 rounded-md text-sm font-medium">Estoque</button>
                        <button data-action="navigate-view" data-view="relatorios" class="nav-btn px-3 py-2 rounded-md text-sm font-medium">Relatórios</button>
                        <div class="relative">
                            <button id="cadastros-menu-btn" data-action="toggle-cadastros-dropdown" class="nav-btn px-3 py-2 rounded-md text-sm font-medium flex items-center">
                                Cadastros <i class="fas fa-chevron-down ml-2 text-xs"></i>
                            </button>
                            <div id="cadastros-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-20">
                                <a href="#" data-action="navigate-view" data-view="localidades" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Localidades</a>
                                <a href="#" data-action="navigate-view" data-view="fornecedores" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Fornecedores</a>
                                <a href="#" data-action="navigate-view" data-view="categorias" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Categorias</a>
                                <a href="#" data-action="navigate-view" data-view="fabricantes" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Fabricantes</a>
                                <a href="#" data-action="navigate-view" data-view="usuarios" id="nav-usuarios" class="hidden block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Usuários</a>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center ml-4">
                         <span id="username-display" class="text-sm text-gray-500 mr-4 font-semibold"></span>
                         <button data-action="logout" class="text-sm text-red-500 hover:text-red-700 font-medium flex items-center"><i class="fas fa-sign-out-alt mr-1"></i>Sair</button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Container Principal -->
        <div class="container mx-auto p-4 md:p-8">
            <header id="viewHeader" class="flex flex-col md:flex-row justify-between items-center mb-6"></header>
            <main id="viewContainer"></main>
            <div id="loading" class="text-center py-10"><i class="fas fa-spinner fa-spin fa-3x text-blue-500"></i><p class="mt-2 text-gray-600">Carregando dados...</p></div>
            <div id="semDados" class="hidden text-center py-10 bg-white rounded-lg shadow"><i class="fas fa-box-open fa-3x text-gray-400"></i><p class="mt-4 text-xl text-gray-500">Nenhum item encontrado.</p><p class="text-gray-400">Comece adicionando itens no botão correspondente.</p></div>
        </div>
    </div>

    <!-- Modais -->
    <div id="modalProduto" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-2xl w-11/12 md:w-2/3 lg:w-1/2 modal-content overflow-y-auto">
            <form id="formProduto" class="p-8">
                <h2 id="modalProdutoTitulo" class="text-2xl font-bold mb-6">Definição de Produto</h2>
                <input type="hidden" name="produtoId">
                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                        <div class="md:col-span-2"><label class="block text-sm font-medium">Nome</label><input type="text" name="nome" required class="mt-1 block w-full p-2 border border-gray-300 rounded-lg"></div>
                        <div class="md:col-span-2"><label class="block text-sm font-medium">Descrição</label><textarea name="descricao" rows="2" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg"></textarea></div>
                        <div class="md:col-span-2"><label class="block text-sm font-medium">URL da Foto</label><input type="url" name="foto_url" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg"></div>
                        <div><label class="block text-sm font-medium">Serial Number</label><input type="text" name="serialNumber" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg"></div>
                        <div><label class="block text-sm font-medium">Unidade</label><input type="text" name="unidade" required class="mt-1 block w-full p-2 border border-gray-300 rounded-lg"></div>
                        <div><label class="block text-sm font-medium">Modelo</label><input type="text" name="modelo" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg"></div>
                        <div><label class="block text-sm font-medium">Categoria</label><select name="categoriaId" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg"></select></div>
                        <div class="md:col-span-2"><label class="block text-sm font-medium">Fabricante</label><select name="fabricanteId" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg"></select></div>
                        <div class="md:col-span-2"><label class="block text-sm font-medium">Fornecedor</label><select name="fornecedorId" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg"></select></div>
                        <div class="md:col-span-2"><label class="block text-sm font-medium">Notas</label><textarea name="notas_internas" rows="2" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg"></textarea></div>
                    </div>
                    <div class="border-t pt-4 mt-4">
                        <div class="flex justify-between items-center mb-2">
                            <p class="text-sm font-bold text-gray-600">Documentos</p>
                            <button type="button" data-action="add-documento" class="text-sm bg-blue-100 text-blue-700 font-semibold py-1 px-3 rounded-md hover:bg-blue-200">Adicionar</button>
                        </div>
                        <div id="documentosContainer" class="space-y-2"></div>
                    </div>
                    <div id="bloco-estoque-inicial" class="border-t pt-4 mt-4">
                        <p class="text-sm font-bold text-gray-600">Estoque Inicial (Opcional)</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                             <div><label class="block text-sm font-medium">Quantidade</label><input type="number" step="any" name="quantidade_inicial" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg"></div>
                             <div><label class="block text-sm font-medium">Localidade</label><select name="localidade_inicial" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg"></select></div>
                        </div>
                    </div>
                </div>
                <div class="flex justify-between items-center mt-8">
                    <button type="button" id="excluirProdutoBtnModal" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700 hidden"><i class="fas fa-trash mr-2"></i>Excluir</button>
                    <div class="ml-auto space-x-4">
                        <button type="button" class="btn-cancel bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">Cancelar</button>
                        <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">Salvar</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <div id="modalAuxiliar" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-2xl w-11/12 md:w-1/2 lg:w-1/3 modal-content overflow-y-auto">
            <form id="formAuxiliar" class="p-8">
                <h2 id="modalAuxiliarTitulo" class="text-2xl font-bold mb-6"></h2>
                <input type="hidden" name="id">
                <input type="hidden" name="collectionName">
                <div id="modalAuxiliarCampos" class="space-y-4"></div>
                <div class="flex justify-end mt-8 space-x-4"><button type="button" class="btn-cancel bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg">Cancelar</button><button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg">Salvar</button></div>
            </form>
        </div>
    </div>
    <div id="modalDetalhes" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-2xl w-11/12 md:w-3/4 lg:w-2/3 modal-content overflow-y-auto p-8">
            <div class="flex justify-between items-start mb-4"><h2 class="text-2xl font-bold" id="detalhesNome"></h2><button class="btn-cancel text-gray-500 hover:text-gray-800 text-2xl">&times;</button></div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-1"><img id="detalhesFoto" src="" alt="Foto do Produto" class="rounded-lg w-full h-auto object-cover shadow-md"></div>
                <div class="md:col-span-2 space-y-3 text-sm">
                    <p><strong>Serial Number:</strong> <span id="detalhesSerialNumber" class="font-mono"></span></p>
                    <p><strong>Descrição:</strong> <span id="detalhesDescricao"></span></p>
                    <p><strong>Fabricante/Modelo:</strong> <span id="detalhesFabricanteModelo"></span></p>
                    <p><strong>Categoria:</strong> <span id="detalhesCategoria"></span></p>
                    <p><strong>Fornecedor:</strong> <span id="detalhesFornecedor"></span></p>
                    <p><strong>Notas:</strong> <span id="detalhesNotas"></span></p>
                    <div class="mt-4"><h4 class="font-bold text-md mb-2">Estoque por Localidade</h4><div id="detalhesEstoqueLocal" class="space-y-1 text-sm"></div></div>
                    <div class="mt-4"><h4 class="font-bold text-md mb-2">Documentos</h4><div id="detalhesDocumentos" class="flex flex-wrap gap-2"></div></div>
                </div>
            </div>
            <div class="mt-8"><h3 class="text-xl font-bold mb-4">Histórico de Movimentação</h3><div id="tabelaHistoricoContainer" class="overflow-x-auto"></div></div>
        </div>
    </div>
    <div id="modalMovimentar" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-2xl w-11/12 md:w-1/2 lg:w-1/3">
            <form id="formMovimentar" class="p-8">
                <h2 class="text-2xl font-bold mb-6">Movimentar Estoque</h2>
                <div class="mb-4"><label class="block text-sm font-medium">Produto</label><select name="produtoId" required class="mt-1 block w-full p-2 border border-gray-300 rounded-lg"></select></div>
                <div class="mb-4"><label class="block text-sm font-medium">Tipo</label><select name="tipo" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg"><option value="ENTRADA">Entrada</option><option value="SAIDA">Saída</option><option value="TRANSFERENCIA">Transferência</option></select></div>
                <div class="mb-4"><label class="block text-sm font-medium">Quantidade</label><input type="number" step="any" name="quantidade" required class="mt-1 block w-full p-2 border border-gray-300 rounded-lg"></div>
                <div id="campoLocalOrigem" class="mb-4 hidden"><label class="block text-sm font-medium">Local de Origem</label><select name="localidadeOrigemId" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg"></select></div>
                <div id="campoLocalDestino" class="mb-4 hidden"><label class="block text-sm font-medium">Local de Destino</label><select name="localidadeDestinoId" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg"></select></div>
                <div class="flex justify-end mt-8 space-x-4"><button type="button" class="btn-cancel bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg">Cancelar</button><button type="submit" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg">Confirmar</button></div>
            </form>
        </div>
    </div>
    <div id="modalUsuario" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-2xl w-11/12 md:w-1/2 lg:w-1/3">
            <form id="formUsuario" class="p-8">
                <h2 class="text-2xl font-bold mb-6">Adicionar Novo Usuário</h2>
                <div class="space-y-4">
                    <div><label class="block text-sm font-medium">Usuário</label><input type="text" name="username" required class="mt-1 block w-full p-2 border rounded-lg"></div>
                    <div><label class="block text-sm font-medium">Email</label><input type="email" name="email" required class="mt-1 block w-full p-2 border border-gray-300 rounded-lg"></div>
                    <div><label class="block text-sm font-medium">Senha</label><input type="password" name="password" required class="mt-1 block w-full p-2 border rounded-lg"></div>
                    <div><label class="block text-sm font-medium">Nível de Acesso</label><select name="role" class="mt-1 block w-full p-2 border rounded-lg"><option value="common">Comum</option><option value="master">Master</option></select></div>
                </div>
                <div class="flex justify-end mt-8 space-x-4"><button type="button" class="btn-cancel bg-gray-200 font-bold py-2 px-6 rounded-lg">Cancelar</button><button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg">Salvar</button></div>
            </form>
        </div>
    </div>
    
    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, getDocs, addDoc, setDoc, updateDoc, deleteDoc, collection, query, where, serverTimestamp, runTransaction, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURAÇÃO E ESTADO GLOBAL ---
        const firebaseConfig = {
          apiKey: "AIzaSyA2QbTc66Hir01rxRBO8d8jbldBbdYVNHQ",
          authDomain: "estoque-5bd20.firebaseapp.com",
          projectId: "estoque-5bd20",
          storageBucket: "estoque-5bd20.appspot.com",
          messagingSenderId: "877422312225",
          appId: "1:877422312225:web:b600eaae6f06a752575c60"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUser = null;
        let currentUserRole = null;
        let currentView = 'estoque';
        
        const caches = {
            produtos: new Map(), localidades: new Map(), categorias: new Map(),
            fabricantes: new Map(), fornecedores: new Map(), usuarios: new Map(),
            estoque: [], historico: []
        };
        const collections = ['produtos', 'localidades', 'categorias', 'fabricantes', 'fornecedores', 'usuarios', 'estoque', 'historico'];

        // --- ELEMENTOS DO DOM ---
        const loginScreen = document.getElementById('login-screen');
        const mainAppScreen = document.getElementById('main-app');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const usernameDisplay = document.getElementById('username-display');
        
        const loadingEl = document.getElementById('loading');
        const semDadosEl = document.getElementById('semDados');
        const viewContainer = document.getElementById('viewContainer');
        const viewHeader = document.getElementById('viewHeader');
        
        // --- FUNÇÕES DE RENDERIZAÇÃO E LÓGICA DE UI (DEFINIDAS PRIMEIRO) ---
        
        function aplicarFiltros(e) {
            const termo = e.target.value.toLowerCase();
            viewContainer.querySelectorAll('.card-item').forEach(card => {
                card.style.display = card.dataset.filterKey.includes(termo) ? '' : 'none';
            });
        }
        
        function renderizarHeader(title, buttonInfo = null) {
            let buttonHtml = '';
            if (buttonInfo && (currentUserRole === 'master' || buttonInfo.action !== 'abrir-modal-usuario')) {
                buttonHtml = `<button data-action="${buttonInfo.action}" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 flex items-center"><i class="${buttonInfo.icon} mr-2"></i>${buttonInfo.text}</button>`;
            }
            viewHeader.innerHTML = `
                <div><h1 class="text-2xl font-bold text-gray-800">${title}</h1></div>
                <div class="flex items-center space-x-4 mt-4 md:mt-0">
                    <input type="text" id="filtroBusca" placeholder="Buscar..." class="w-full md:w-auto p-2 border border-gray-300 rounded-lg">
                    ${buttonHtml}
                </div>
            `;
            document.getElementById('filtroBusca').addEventListener('input', aplicarFiltros);
        }

        // --- VIEWS PRINCIPAIS ---
        function renderizarViewEstoque() {
            renderizarHeader('Visão Geral do Estoque', {action: 'abrir-modal-produto', text: 'Adicionar Produto', icon: 'fas fa-plus'});
            
            if (caches.produtos.size === 0) { semDadosEl.style.display = 'block'; return; }
            const grid = document.createElement('div');
            grid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
            
            caches.produtos.forEach(produto => {
                const totalEstoque = caches.estoque.filter(e => e.produtoId === produto.id).reduce((sum, e) => sum + e.quantidade, 0);
                const card = document.createElement('div');
                card.className = "card-item bg-white rounded-lg shadow-md overflow-hidden";
                card.dataset.filterKey = `${produto.nome} ${caches.fabricantes.get(produto.fabricanteId)?.nome || ''} ${produto.modelo} ${produto.serialNumber || ''}`.toLowerCase();
                const cor = totalEstoque <= 0 ? 'text-red-500' : 'text-green-600';
                card.innerHTML = `
                    <div class="flex items-start p-4">
                        <img src="${produto.foto_url || 'https://placehold.co/100x100/e2e8f0/cbd5e0?text=N/A'}" alt="Foto" class="w-24 h-24 object-cover rounded-md mr-4">
                        <div class="flex-grow">
                            <h3 class="font-bold text-lg">${produto.nome}</h3>
                            <p class="text-sm text-gray-500">${caches.fabricantes.get(produto.fabricanteId)?.nome || ''} ${produto.modelo || ''}</p>
                            <p class="text-xs text-gray-400 font-mono">${produto.serialNumber || ''}</p>
                            <div class="mt-2 text-xl font-bold ${cor}">${totalEstoque} <span class="text-sm font-medium text-gray-500">${produto.unidade}</span></div>
                            <p class="text-xs text-gray-400">em ${caches.estoque.filter(e => e.produtoId === produto.id && e.quantidade > 0).length} locais</p>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-3 flex justify-end space-x-3">
                        <button data-action="detalhes" data-id="${produto.id}" class="text-sm text-blue-600 font-semibold">Detalhes</button>
                        <button data-action="movimentar" data-id="${produto.id}" class="text-sm text-green-600 font-semibold">Movimentar</button>
                        <button data-action="editar-produto" data-id="${produto.id}" class="text-sm text-yellow-600 font-semibold">Editar</button>
                    </div>`;
                grid.appendChild(card);
            });
            viewContainer.innerHTML = '';
            viewContainer.appendChild(grid);
        }

        function renderizarViewAuxiliar(collectionName, title) {
            const buttonInfo = currentUserRole === 'master' ? {action: `abrir-modal-auxiliar`, collection: collectionName, text: `Adicionar ${title.slice(0, -1)}`, icon: 'fas fa-plus'} : null;
            renderizarHeader(title, buttonInfo);
            
            const cache = caches[collectionName];
            if (cache.size === 0) { semDadosEl.style.display = 'block'; return; }
            const list = document.createElement('div');
            list.className = 'bg-white rounded-lg shadow-md divide-y divide-gray-200';
            
            cache.forEach(item => {
                let details = '';
                if(collectionName === 'fornecedores' && item.contato_nome) {
                    details = `<span class="text-sm text-gray-500 ml-4">${item.contato_nome} - ${item.contato_whatsapp || 'N/A'}</span>`;
                }
                list.innerHTML += `
                    <div class="card-item p-4 flex justify-between items-center" data-filter-key="${item.nome.toLowerCase()}">
                        <div><span class="font-medium">${item.nome}</span>${details}</div>
                        ${currentUserRole === 'master' ? `
                        <div>
                            <button data-action="editar-auxiliar" data-collection="${collectionName}" data-id="${item.id}" class="text-yellow-600 px-2"><i class="fas fa-edit"></i></button>
                            <button data-action="excluir-item" data-collection="${collectionName}" data-id="${item.id}" class="text-red-600 px-2"><i class="fas fa-trash"></i></button>
                        </div>` : ''}
                    </div>`;
            });
            viewContainer.innerHTML = '';
            viewContainer.appendChild(list);
        }

        function renderizarViewUsuarios() {
            renderizarHeader('Gestão de Usuários', {action: 'abrir-modal-usuario', text: 'Adicionar Usuário', icon: 'fas fa-plus'});

            const list = document.createElement('div');
            list.className = 'bg-white rounded-lg shadow-md divide-y divide-gray-200';
            
            caches.usuarios.forEach((user, id) => {
                list.innerHTML += `
                    <div class="card-item p-4 flex justify-between items-center" data-filter-key="${user.username.toLowerCase()} ${user.email.toLowerCase()}">
                        <div>
                            <span class="font-medium">${user.username}</span>
                            <span class="text-sm text-gray-500 ml-4">${user.email}</span>
                            <span class="ml-4 text-xs font-semibold uppercase px-2 py-1 rounded-full ${user.role === 'master' ? 'bg-blue-200 text-blue-800' : 'bg-gray-200 text-gray-800'}">${user.role}</span>
                        </div>
                        ${currentUser.uid !== id ? // Não pode excluir a si mesmo
                        `<div>
                            <button data-action="excluir-usuario" data-id="${id}" class="text-red-600 px-2"><i class="fas fa-trash"></i></button>
                        </div>` : ''}
                    </div>`;
            });
            viewContainer.innerHTML = '';
            viewContainer.appendChild(list);
        }

        // --- LÓGICA DE RELATÓRIOS ---
        function renderizarViewRelatorios() {
            renderizarHeader('Relatórios');
            let reportNavButtons = `
                <button data-action="render-report" data-report="estoquePorLocal" class="report-nav-btn-active">Estoque por Local</button>
                <button data-action="render-report" data-report="movimentacoes" class="report-nav-btn">Movimentações</button>
                <button data-action="render-report" data-report="listaEstoque" class="report-nav-btn">Lista de Estoque</button>
                <button data-action="render-report" data-report="listaFabricante" class="report-nav-btn">Lista por Fabricante</button>
            `;
            if (currentUserRole === 'master') {
                reportNavButtons += `<button data-action="render-report" data-report="movimentacoesUsuario" class="report-nav-btn">Movimentações por Usuário</button>`;
            }

            viewContainer.innerHTML = `
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <div id="report-nav" class="flex flex-wrap gap-2 border-b border-gray-200 mb-4 pb-2">
                        ${reportNavButtons}
                    </div>
                    <div id="report-content"></div>
                </div>
            `;
            
            renderizarRelatorio('estoquePorLocal'); // Renderiza o primeiro relatório por padrão
        }

        function renderizarRelatorio(reportName) {
            const content = document.getElementById('report-content');
            content.innerHTML = '';
            switch (reportName) {
                case 'estoquePorLocal': renderRelatorioEstoquePorLocal(content); break;
                case 'movimentacoes': renderRelatorioMovimentacoes(content); break;
                case 'listaEstoque': renderRelatorioListaEstoque(content); break;
                case 'listaFabricante': renderRelatorioListaFabricante(content); break;
                case 'movimentacoesUsuario': renderRelatorioMovimentacoesUsuario(content); break;
            }
        }

        // ... (resto do código dos relatórios e outras funções)
        
        // --- MANIPULADOR DE EVENTOS CENTRAL ---
        document.addEventListener('click', (e) => {
            const target = e.target.closest('[data-action]');
            if (!target) return;

            const { action, id, collection, view, report } = target.dataset;
            
            // Ações de Navegação e Menus
            if (action === 'navigate-view') {
                e.preventDefault();
                currentView = view;
                renderizarView();
            } else if (action === 'toggle-cadastros-dropdown') {
                document.getElementById('cadastros-dropdown').classList.toggle('hidden');
            } else if (action === 'logout') {
                signOut(auth);
            }
            // Ações de Abertura de Modal
            else if (action === 'abrir-modal-produto') abrirModalProduto(id);
            else if (action === 'abrir-modal-usuario') abrirModalUsuario();
            else if (action === 'abrir-modal-auxiliar') abrirModalAuxiliar(collection);
            else if (action === 'detalhes') abrirModalDetalhes(id);
            else if (action === 'movimentar') abrirModalMovimentar(id);
            else if (action === 'editar-produto') abrirModalProduto(id);
            else if (action === 'editar-auxiliar') abrirModalAuxiliar(collection, id);
            // Ações de Exclusão
            else if (action === 'excluir-item') excluirItem(collection, id);
            else if (action === 'excluir-usuario') alert("Função de excluir usuário precisa ser implementada com cuidado (Admin SDK).");
            // Ações de Relatório
            else if (action === 'render-report') {
                document.getElementById('report-nav').querySelectorAll('button').forEach(btn => {
                    btn.classList.remove('report-nav-btn-active');
                    btn.classList.add('report-nav-btn');
                });
                target.classList.add('report-nav-btn-active');
                target.classList.remove('report-nav-btn');
                renderizarRelatorio(report);
            } else if (action === 'add-documento') {
                addDocumentoField();
            }
        });
    </script>
</body>
</html>
